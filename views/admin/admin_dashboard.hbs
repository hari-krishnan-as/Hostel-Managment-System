<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-[#16213E] text-[#FFFFFF] flex flex-col md:flex-row min-h-screen">
  
  <!-- Sidebar -->
  <aside class="w-full md:w-64 bg-[#1A1A2E] flex md:flex-col justify-between py-4 md:py-8 border-b md:border-r border-[#0F3460]">
    <nav class="flex-1 px-4 md:px-8">
      <h2 class="text-base md:text-lg font-bold text-red-500 mb-4 md:mb-6 uppercase tracking-wide bg-[#0F3460] p-2 md:p-3 rounded-md text-center">
        Dashboard
      </h2>
      <ul class="flex md:flex-col space-x-4 md:space-x-0 md:space-y-4 overflow-x-auto md:overflow-visible">
        <li>
          <a href="/admin/dashboard" class="flex items-center space-x-2 md:space-x-4 p-2 pl-3 md:pl-4 rounded-md bg-[#0F3460] border-l-4 border-[#E94560]">
            <i class="fas fa-home text-[#E94560]"></i><span class="hidden sm:inline">Home</span>
          </a>
        </li>
        <li>
          <a href="pending-users" class="flex items-center space-x-2 md:space-x-4 p-2 pl-3 md:pl-4 rounded-md hover:bg-[#0F3460] hover:border-l-4 hover:border-[#E94560] transition">
            <i class="fas fa-user-check text-[#E94560]"></i><span class="hidden sm:inline">Registered Students</span>
          </a>
        </li>
        <li>
          <a href="expense-log" class="flex items-center space-x-2 md:space-x-4 p-2 pl-3 md:pl-4 rounded-md hover:bg-[#0F3460] hover:border-l-4 hover:border-[#E94560] transition">
            <i class="fas fa-receipt text-[#E94560]"></i><span class="hidden sm:inline">Expense Log</span>
          </a>
        </li>
        <li>
          <a href="/admin/approve-messcut" class="flex items-center space-x-2 md:space-x-4 p-2 pl-3 md:pl-4 rounded-md hover:bg-[#0F3460] hover:border-l-4 hover:border-[#E94560] transition">
            <i class="fas fa-utensils text-[#E94560]"></i>
            <span class="hidden sm:inline">Approve Mess Cut Leave</span>
          </a>
        </li>
        <li>
          <a href="view-complaint" class="flex items-center space-x-2 md:space-x-4 p-2 pl-3 md:pl-4 rounded-md hover:bg-[#0F3460] hover:border-l-4 hover:border-[#E94560] transition">
            <i class="fas fa-exclamation-circle text-[#E94560]"></i><span class="hidden sm:inline">View Complaints</span>
          </a>
        </li>
        <li>
          <a href="view-suggestion" class="flex items-center space-x-2 md:space-x-4 p-2 pl-3 md:pl-4 rounded-md hover:bg-[#0F3460] hover:border-l-4 hover:border-[#E94560] transition">
            <i class="fas fa-lightbulb text-[#E94560]"></i><span class="hidden sm:inline">View Suggestions</span>
          </a>
        </li>
        <li>
          <a href="give-notification" class="flex items-center space-x-2 md:space-x-4 p-2 pl-3 md:pl-4 rounded-md hover:bg-[#0F3460] hover:border-l-4 hover:border-[#E94560] transition">
            <i class="fas fa-bullhorn text-[#E94560]"></i><span class="hidden sm:inline">Give Notification</span>
          </a>
        </li>
        <li>
          <a href="upload-sheet" class="flex items-center space-x-2 md:space-x-4 p-2 pl-3 md:pl-4 rounded-md hover:bg-[#0F3460] hover:border-l-4 hover:border-[#E94560] transition">
            <i class="fas fa-lightbulb text-[#E94560]"></i><span class="hidden sm:inline">Upload Students List</span>
          </a>
        </li>
      </ul>
    </nav>
    <div class="px-4 md:px-8 mt-2 md:mt-auto">
      <a href="/logout" class="flex items-center space-x-2 md:space-x-4 p-2 rounded-md text-[#EEEEEE] hover:text-[#E94560] transition">
        <i class="fas fa-sign-out-alt"></i><span class="hidden sm:inline font-semibold">Log Out</span>
      </a>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="flex flex-col flex-1">
    
    <!-- Header -->
    <header class="w-full flex items-center justify-end py-3 md:py-4 px-4 md:px-6 bg-[#0F3460] text-white">
      <div class="flex items-center space-x-4 md:space-x-6">
        <a href="#" class="hover:text-gray-400 transition">
          <i class="fas fa-cog text-lg"></i>
        </a>
        <a href="#" class="hover:text-gray-400 transition">
          <i class="fas fa-user-circle text-lg"></i>
        </a>
      </div>
    </header>
    <!-- Home Section -->
    <main class="p-4 md:p-8 flex-1">
      <div class="w-full max-w-4xl mx-auto">
        <h1 class="text-xl md:text-3xl font-bold text-gray-50 mb-6">
          Welcome back, <span class="text-pink-500">{{user.name}}</span>!
        </h1>
        
                <div id="bill-notification-area" class="mb-8">
                  </div>
        
                <div id="bill-display-area" class="p-6 bg-[#1A1A2E] rounded-lg shadow-xl hidden">
          <h3 class="text-2xl font-bold text-red-400 mb-4">Latest Monthly Bill</h3>
          <div id="bill-content">
                      </div>
            <a href="/user/mess-bill" class="text-red-400 hover:text-red-300 mt-4 block text-sm font-semibold pt-4 border-t border-[#0F3460]">
                View Full Bill History &rarr;
            </a>
        </div>
        
              </div>
    </main>
  </div>
  
    <script>
    const notificationArea = document.getElementById('bill-notification-area');
    const billDisplayArea = document.getElementById('bill-display-area');
    const billContent = document.getElementById('bill-content');

    // Function to format the bill data into HTML
    function renderBill(billData) {
        const { bills } = billData;
        
        if (!bills || bills.length === 0) {
            return '<p class="text-gray-400">No bill data found yet.</p>';
        }

        const latestBill = bills[0];
        
        return `
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                <div class="bg-[#0F3460] p-4 rounded-md">
                    <p class="text-sm text-gray-400">Billing Cycle</p>
                    <p class="text-lg font-semibold text-red-300">${latestBill.displayDate}</p>
                </div>
                <div class="bg-[#0F3460] p-4 rounded-md">
                    <p class="text-sm text-gray-400">Your Share</p>
                    <p class="text-xl font-bold text-green-400">${latestBill.formattedShare}</p>
                </div>
                <div class="bg-[#0F3460] p-4 rounded-md">
                    <p class="text-sm text-gray-400">Present Days</p>
                    <p class="text-lg font-semibold">${latestBill.presentDays}</p>
                </div>
            </div>
            <p class="text-xs text-gray-400 mt-4">Total Mess Expense for the Cycle: ${latestBill.formattedTotalExpense} | Rate Per Day: ${latestBill.formattedRate}</p>
        `;
    }

    // Function to fetch the bill data, clear the flag, and display the bill
    async function viewLatestBill() {
        // Clear the notification area immediately to show action is taken
        notificationArea.innerHTML = ''; 
        
        // Show a loading spinner (optional)
        billDisplayArea.classList.remove('hidden');
        billContent.innerHTML = '<p class="text-center text-gray-400"><i class="fas fa-spinner fa-spin mr-2"></i> Loading bill data...</p>';

        try {
            // Fetch the bill data which will also reset the needsBillRefresh flag on the server
            const response = await fetch('/user/fetch-latest-bill-data');
            const result = await response.json();

            if (response.ok && result.success && result.billData) {
                // Render the data
                billContent.innerHTML = renderBill(result.billData);
                
            } else {
                billContent.innerHTML = `<p class="text-red-500">Error: ${result.message || 'Could not fetch the latest bill data.'}</p>`;
            }
        } catch (error) {
            console.error('Fetch error:', error);
            billContent.innerHTML = '<p class="text-red-500">A network error occurred while fetching the bill.</p>';
        }
    }

    // Function to check bill status on page load
    async function checkBillStatus() {
        try {
            // Check the status flag
            const response = await fetch('/user/bill-status');
            const result = await response.json();

            if (result.billGenerated) {
                notificationArea.innerHTML = `
                    <div class="bg-green-600 p-4 rounded-md flex flex-col md:flex-row justify-between items-center text-white shadow-lg border-2 border-green-400">
                        <p class="font-semibold text-lg"><i class="fas fa-receipt mr-2"></i> A NEW MESS BILL HAS BEEN GENERATED!</p>
                        <button onclick="viewLatestBill()" class="mt-3 md:mt-0 bg-white text-green-600 px-4 py-2 rounded-md font-bold hover:bg-gray-200 transition shadow-md">
                            View Bill
                        </button>
                    </div>
                `;
            } 
            // Optional: If you want the bill area visible, uncomment this
            /*
            else {
                 billDisplayArea.classList.remove('hidden');
                 billContent.innerHTML = '<p class="text-gray-400">No new bill notification. View history for past bills.</p>';
            }
            */
            
        } catch (error) {
            console.error('Status check error:', error);
            // Ignore errors for status check to prevent interrupting dashboard loading
        }
    }

    // Run the check when the page loads
    checkBillStatus();
</script>
</body>
</html>